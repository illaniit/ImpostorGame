# Guía de Despliegue en Vercel (Paso a Paso)

Para dejar tu juego "Impostor" funcionando al 100% en Vercel, sigue estos 3 pasos principales.

## 1. Configurar la Base de Datos (Supabase)
Lo más importante es que la base de datos tenga las tablas y las funciones de seguridad.

1.  Entra a tu proyecto en [Supabase](https://supabase.com/dashboard).
2.  Ve a la sección **SQL Editor** (icono de hoja de papel en la barra lateral).
3.  Haz clic en "New Query".
4.  **Copia y Pega** el siguiente código SQL completo y dale al botón **RUN**:

```sql
-- 1. Habilitar UUIDs
create extension if not exists "uuid-ossp";

-- 2. Tipos de Datos (Enums)
create type room_status as enum ('LOBBY', 'PLAYING', 'VOTING', 'ENDED');
create type player_role as enum ('CIVILIAN', 'IMPOSTOR');

-- 3. Tablas
create table if not exists profiles (
  id uuid references auth.users not null primary key,
  username text unique,
  avatar_url text,
  is_admin boolean default false,
  updated_at timestamp with time zone default timezone('utc'::text, now())
);

create table if not exists word_packs (
  id bigint generated by default as identity primary key,
  category text not null,
  civilian_word text not null,
  impostor_word text,
  created_at timestamp with time zone default timezone('utc'::text, now())
);

create table if not exists rooms (
  id uuid default uuid_generate_v4() primary key,
  code text unique not null,
  host_id uuid references profiles(id) not null,
  status room_status default 'LOBBY'::room_status,
  impostor_count int default 1,
  created_at timestamp with time zone default timezone('utc'::text, now())
);

create table if not exists players (
  id uuid default uuid_generate_v4() primary key,
  room_id uuid references rooms(id) on delete cascade not null,
  user_id uuid references profiles(id) not null,
  is_alive boolean default true,
  votes_received int default 0,
  created_at timestamp with time zone default timezone('utc'::text, now()),
  unique(room_id, user_id)
);

create table if not exists player_roles (
  player_id uuid references players(id) on delete cascade primary key,
  role player_role,
  secret_word text
);

-- 4. Seguridad (Row Level Security)
alter table profiles enable row level security;
alter table rooms enable row level security;
alter table players enable row level security;
alter table player_roles enable row level security;
alter table word_packs enable row level security;

-- Políticas de Seguridad
create policy "Perfiles públicos" on profiles for select using (true);
create policy "Usuario edita su perfil" on profiles for update using (auth.uid() = id);
create policy "Usuario inserta su perfil" on profiles for insert with check (auth.uid() = id);

create policy "Salas públicas" on rooms for select using (true);
create policy "Autenticados crean salas" on rooms for insert with check (auth.role() = 'authenticated');
create policy "Anfitrión actualiza sala" on rooms for update using (auth.uid() = host_id);

create policy "Jugadores públicos" on players for select using (true);
create policy "Autenticados se unen" on players for insert with check (auth.uid() = user_id);
create policy "Sistema actualiza jugadores" on players for update using (true);

-- LA POLÍTICA ANTI-TRAMPAS: Solo tú puedes ver tu rol
create policy "Secretos privados" on player_roles for select using (
  auth.uid() = (select user_id from players where id = player_roles.player_id)
);

-- 5. Funciones del Juego (Lógica del Servidor)
create or replace function assign_roles(p_roles jsonb)
returns void
language plpgsql
security definer
as $$
declare
  r record;
begin
  for r in select * from jsonb_to_recordset(p_roles) as x(player_id uuid, role player_role, secret_word text)
  loop
    insert into player_roles (player_id, role, secret_word)
    values (r.player_id, r.role, r.secret_word)
    on conflict (player_id) do update set role = r.role, secret_word = r.secret_word;
  end loop;
end;
$$;

create or replace function check_game_over(p_room_id uuid)
returns text
language plpgsql
security definer
as $$
declare
  v_impostors_alive int;
  v_civilians_alive int;
begin
  select count(*) into v_impostors_alive from players p
  join player_roles pr on p.id = pr.player_id
  where p.room_id = p_room_id and p.is_alive = true and pr.role = 'IMPOSTOR';

  select count(*) into v_civilians_alive from players p
  join player_roles pr on p.id = pr.player_id
  where p.room_id = p_room_id and p.is_alive = true and pr.role = 'CIVILIAN';

  if v_impostors_alive = 0 then
    update rooms set status = 'ENDED' where id = p_room_id;
    return 'CIVILIANS_WIN';
  end if;

  if v_impostors_alive >= v_civilians_alive then
    update rooms set status = 'ENDED' where id = p_room_id;
    return 'IMPOSTORS_WIN';
  end if;

  return 'CONTINUE';
end;
$$;
```

---

## 2. Subir el Código a GitHub
Vercel necesita que tu código esté en GitHub.

1.  Crea un **nuevo repositorio** en [GitHub.com](https://github.com/new) (llámalo `impostor-game` o como quieras).
2.  Sube los archivos de esta carpeta a ese repositorio. Si usas la terminal:
    ```bash
    git init
    git add .
    git commit -m "Juego listo"
    git branch -M main
    git remote add origin https://github.com/TU_USUARIO/TU_REPO.git
    git push -u origin main
    ```

---

## 3. Desplegar en Vercel

1.  Ve a [Vercel](https://vercel.com/new).
2.  Selecciona tu repositorio de GitHub `impostor-game` y dale a **Import**.
3.  **IMPORTANTE - Variables de Entorno**:
    Antes de darle a "Deploy", despliega la sección **"Environment Variables"** y añade estas dos (las sacas de Supabase -> Project Settings -> API):
    
    *   **NAME**: `NEXT_PUBLIC_SUPABASE_URL`
        *   **VALUE**: (Tu URL de Supabase, ej: `https://xyz.supabase.co`)
        
    *   **NAME**: `NEXT_PUBLIC_SUPABASE_ANON_KEY`
        *   **VALUE**: (Tu clave `anon` / `public`)

4.  Dale al botón **Deploy**.

¡Y listo! En un minuto tendrás una URL (ej: `impostor-game.vercel.app`) para compartir con tus amigos.
